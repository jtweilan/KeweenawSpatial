

<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Historical Photos Index Map</title>
  <script type="module" src="https://js.arcgis.com/calcite-components/2.10.1/calcite.esm.js"></script>
<link rel="stylesheet" type="text/css" href="https://js.arcgis.com/calcite-components/2.10.1/calcite.css" />
   <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">  
  <link rel="stylesheet" href="https://js.arcgis.com/4.30/esri/themes/dark/main.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.6/viewer.css" integrity="sha512-eG8C/4QWvW9MQKJNw2Xzr0KW7IcfBSxljko82RuSs613uOAg/jHEeuez4dfFgto1u6SRI/nXmTr9YPCjs1ozBg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <script src="https://code.jquery.com/jquery-3.6.0.js" integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk=" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.min.js" integrity="sha512-3j3VU6WC5rPQB4Ld1jnLV7Kd5xr+cq9avvhwqzbH/taCRNURoeEpoPBK9pDyeukwSxwRPJ8fDgvYXd6SkaZ2TA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/viewerjs/1.11.6/viewer.min.js" integrity="sha512-EC3CQ+2OkM+ZKsM1dbFAB6OGEPKRxi6EDRnZW9ys8LghQRAq6cXPUgXCCujmDrXdodGXX9bqaaCRtwj4h4wgSQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>  
  <link rel="stylesheet" href="https://unpkg.com/@sjmc11/tourguidejs/dist/css/tour.min.css">
  <script src="https://unpkg.com/@sjmc11/tourguidejs/dist/tour.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://js.arcgis.com/4.30/"></script>
  <style>

    body, html {
      font-family: 'Montserrat', sans-serif !important;
    }
    
    #viewDiv {
      position: absolute;
      top: 0;
      bottom: 0;      
      padding: 0;              
      width: 80%;
      left:  20%;
    }   

    /*Navbar*/
    .navbar {
      height: 56px;
    }
    .navbar-brand {
      padding: 0;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;   
      color: white !important; 
    }
    /*Navbar links*/
    .navbar-light .navbar-nav .nav-link {
      color: #d9dde0;
      font-size: 13px;
    }
    .navbar-light .navbar-nav .nav-link:visited {
      color: #d9dde0;  
    }

    .navbar-light .navbar-nav .nav-link:hover {
      color: white;  
    }

    /*Navbar background color*/
    .bg-light {
      background: #353535 !important;
      border-bottom: solid 1px #555;
    }   

    /*Search bar container*/
    .container {   
        margin-top: 5px;
        width: 100%;                  
     }

    #search {
      width: 50%;    
      border-radius: 0px 0px 0px 0px;   
      background-color:  black;
      border-color: #767576;
    } 

    .btn-outline-warning {      
      color: #000;
      border-radius: 0px 0px 0px 0px; 
      border-color: gray;
      background-color: gray;        
    }

    .btn-outline-warning:hover {
      color: #000;
      border-color: #FC0;
      background-color: #FC0;
    }

    .calcite-tutorial {
      --calcite-ui-brand: #FC0;
      --calcite-ui-brand-hover: #008D52;     
    }

    .calcite-tutorial calcite-chip {
      --calcite-ui-foreground-2: var(--calcite-ui-foreground-2);
      --calcite-ui-text-1: #FC0;
      opacity:  1;      
    }  

    #control-reset-el {
      color: #FC0;
    }

     #searchDiv {
      float: right;
      margin:  5px;
      width:  auto;
      border-color: #767576 !important;
    }

    .esri-input {
      border: 1px solid #767576 !important;
    }
    .esri-search__submit-button {
      background-color: #009af2;
      border: solid 1px #009af2;
    }

    .esri-search__submit-button:hover {
      background-color: #007ac2;
      border:  solid 1px #007ac2;
    }
    
    .esri-icon-search {
      color: black !important;
      font-weight: bold !important;
    }

    h10 {
      color: #FC0;
    }

    h11 {
      font-weight: bolder;
    }

    h5 {
      color: white;
    }

    #image {
      display: none;
    }

  .esri-popup__content img {
    cursor: pointer;
  }

  .esri-ui {
    z-index: 2 !important;
  }

  .viewer-title {
    color: white;
    font-size: 14px;
    opacity: 1; 
  }

  #selectmap {
    position: absolute;
    top: 15px;
    right: 15px;    
  }

  #searchEtx {
    position: absolute;
    top: 15px;
    left: 55px;
    z-index: 1 !important;
   --calcite-color-background: black;
   color: black !important;

  }

  /* Custom scrollbar */
  /* width */
  ::-webkit-scrollbar {
    width: 10px !important;
  }

  /* Track */
  ::-webkit-scrollbar-track {
    background: #f1f1f1 !important; 
  }
   
  /* Handle */
  ::-webkit-scrollbar-thumb {
    background: #888 !important; 
  }

  /* Handle on hover */
  ::-webkit-scrollbar-thumb:hover {
    background: #555 !important; 
  }

  .thumbnail {
     width: 50px;
    height: 50px;
    border-radius: 50%;
    object-fit: cover;
    margin-left: 10px; /* Adjust as needed */
    float: right;
  }
  </style>
</head>
<body class="calcite-mode-dark">
<nav class="navbar navbar-expand-md navbar-light bg-light">
  <a class="navbar-brand" href="https://mtugrf.github.io/mapcatalog/" target="_blank" rel="noopener">
    <img src="photo3.svg" width="50" height="60" class="d-inline-block align-top" style="margin-bottom: 0px" alt="">
      &nbsp;&nbsp;CCHI Spatial Image Catalog
  </a>
  <div class="collapse navbar-collapse" id="navbarNav" style="">
        <ul class="navbar-nav mr-auto">           
        </ul>
        <ul class="navbar-nav">
            <li class="nav-item">
                <a class="nav-link" href="https://cchi.mtu.edu" target="_blank" rel="noopener">CCHI</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="https://www.mtu.edu/social-sciences/" target="_blank" rel="noopener">Social Sciences</a>
            </li>           
        </ul>
    </div>
</nav>
  <calcite-shell content-behind class="calcite-tutorial" style="height: auto;margin-top: 56px">    
  <calcite-shell class="calcite-tutorial">
    <calcite-shell-panel slot="panel-start">       
      <calcite-panel>
<!-- <div id="searchDiv"></div> -->
<div>
  <!-- Default Image for ViewerJS -->
  <img id="image" src="" alt="Picture">
</div>   
<div id="searchDiv"></div>
        <calcite-label html-for="hmtoggle" layout="inline">
          <calcite-checkbox id="hmtoggle" checked="true" scale="l" style="padding: 5px"></calcite-checkbox> Show Heatmap
          </calcite-label>
          <calcite-label>
              
        <calcite-panel id="resultsDiv">
        <h4 class="heading" id="result-block" slot="header-content" style="font-size: var(--calcite-font-size--1); color: var(--calcite-ui-text-1);">
         
        </h4>
        <calcite-notice open icon="information-f" id="instruction">
    <div slot="title"><b>Using the application</b></div>
    <div slot="message">Click anywhere on the map to see images for that location. OR use the search bar to locate images by keyword. OR use the <b>Search Here</b> button to locate images within the current map extent.</div>
    <calcite-link class="data-tg-tour" slot="link" title="Take a Tour" id="start-tour">
        Take a Tour
    </calcite-link>
</calcite-notice>
          <calcite-list id="result-list"></calcite-list>     
    </calcite-shell-panel>
  </calcite-shell>
<div id="viewDiv">
  <calcite-button id="searchEtx" kind="brand">Search Here</calcite-button>
  <calcite-select id="selectmap">
    <calcite-option label="Choose Historical Map" value="none" selected="true"></calcite-option>
    <calcite-option label="1888 Sanborn Map" value="1888"></calcite-option> 
    <calcite-option label="1900 Sanborn Map" value="1900"></calcite-option>
    <calcite-option label="1908 Sanborn Map" value="1908"></calcite-option>
    <calcite-option label="1917 Sanborn Map" value="1917"></calcite-option>
    <calcite-option label="1928 Sanborn Map" value="1928"></calcite-option>
    <calcite-option label="1949 Sanborn Map" value="1949"></calcite-option>
  </calcite-select>
</div>
</body>

<script>

  require([
    "esri/Map",
    "esri/views/MapView",
    "esri/Graphic",
    "esri/layers/FeatureLayer",
    "esri/layers/TileLayer",
    "esri/layers/GraphicsLayer",    
    "esri/Basemap",    
    "esri/widgets/Home",
    "esri/widgets/Search",
    "esri/core/reactiveUtils",
    "esri/geometry/Point",
    "esri/rest/support/Query"       
  ], (Map, MapView, Graphic, FeatureLayer, TileLayer, GraphicsLayer, Basemap, Home, Search, reactiveUtils, Point, Query) => (async () => {

      // Create an object to store tile layers
      const tileLayers = {
        map_1949: new TileLayer({
          url: "https://portal1-geo.sabu.mtu.edu/server/rest/services/KeweenawHSDI/Kett_19496_FIPS/MapServer?f=jsapi",
        }),
        map_1888: new TileLayer({
          url: "https://portal1-geo.sabu.mtu.edu/server/rest/services/KeweenawHSDI/KeTT_1888_FIPS/MapServer",
        }),
        map_1900: new TileLayer({
          url: "https://portal1-geo.sabu.mtu.edu/server/rest/services/KeweenawHSDI/KeTT_1900_FIPS/MapServer",
        }),
        map_1908: new TileLayer({
          url: "https://portal1-geo.sabu.mtu.edu/server/rest/services/KeweenawHSDI/KeTT_1908_FIPS/MapServer",
        }),
        map_1917: new TileLayer({
          url: "https://portal1-geo.sabu.mtu.edu/server/rest/services/KeweenawHSDI/KeTT_1917_FIPS/MapServer",    
        }),
         map_1928: new TileLayer({
          url: "https://portal1-geo.sabu.mtu.edu/server/rest/services/KeweenawHSDI/KeTT_1928_FIPS/MapServer",    
        }), 
         map_1942: new TileLayer({
          url: "https://portal1-geo.sabu.mtu.edu:6443/arcgis/rest/services/KeweenawHSDI/KeTT_1942_FIPS/MapServer",    
        }),        
         map_1938: new TileLayer({
          url: "https://portal1-geo.sabu.mtu.edu/server/rest/services/Hosted/38_Aerials/MapServer",    
        }), 
         map_1954: new TileLayer({
          url: "https://portal1-geo.sabu.mtu.edu/server/rest/services/Hosted/mtu1955/MapServer",    
        }), 
         map_1951: new TileLayer({
          url: "https://portal1-geo.sabu.mtu.edu/server/rest/services/Hosted/HoughtonHancock_1951_Orthomosaic_LVerissimo_V02/MapServer",    
        }), 
         map_1955: new TileLayer({
          url: "https://portal1-geo.sabu.mtu.edu/server/rest/services/Hosted/mtu1955/MapServer",    
        }), 
         map_1965: new TileLayer({
          url: "https://tiles.arcgis.com/tiles/RPhrOu9XQzI31xTa/arcgis/rest/services/MTU_Campus_1965/MapServer",    
        }),
      };   

      // Keep track of the currently active tile layers
      let activeTileLayer = null;

      // Create a style for the indexLayer
     const renderer = {
        type: "simple",  // autocasts as new SimpleRenderer()
        symbol: {
          type: "simple-fill",  // autocasts as new SimpleFillSymbol()
          color: [ 255, 128, 0, 0 ],
          outline: {  // autocasts as new SimpleLineSymbol()
            width: 1,
            color: "red"
          }
        }
      }; 

      // renderer for the focal points layer
      const camera = {
       type: "simple",
       symbol: {
          type: "picture-marker",
          url: 'camera.svg',
          width: 20,
          height: 20
       }
      }

      const hmrenderer = {
        type: "heatmap",
         colorStops: [
          { ratio: 0.1, color: "rgba(0, 0, 0, 0)" },             // Fully transparent
          { ratio: 0.2, color: "rgba(72, 61, 139, 0.7)" },     // Dark Purple (Medium transparency)
          { ratio: 0.4, color: "rgba(0, 128, 128, 0.7)" },     // Teal (Medium transparency)
          { ratio: 0.6, color: "rgba(255, 255, 0, 0.8)" },     // Yellow (More opaque)
          { ratio: 0.8, color: "rgba(255, 105, 180, 0.9)" },   // Pink (Almost fully opaque)
          { ratio: 1, color: "rgba(255, 20, 147, 1)" }         // Deep Pink (Fully opaque)
        ],
      blurRadius: 15,
      maxDensity: 0.00875,
          minDensity: 0
    };

    // keep track of anything highlighted
    let highlightSelect;

    const map = new Map({
      basemap: "hybrid"      
    });

    const view = new MapView({
      container: "viewDiv",
      map: map,
      center: [-88.3028615, 47.144998],
      zoom: 10,
      highlightOptions: {
      color: "red", // color of the highlight when a feature is selected
      fillOpacity: 0.1
      },
    });

    // create a new graphics layer for the sketch
    const graphicsLayer = new GraphicsLayer();

    const layer = new FeatureLayer({
      url:
        "https://services2.arcgis.com/RPhrOu9XQzI31xTa/arcgis/rest/services/CCHI_Viewsheds_meatadata/FeatureServer/0",
      outFields: ["*"],
      renderer: renderer,  
      maxScale: 35.505170,  
      minScale: 0,   
      opacity: 0,
      popupEnabled: false,
      id: "viewsheds"
    });  

    const pointlayer = new FeatureLayer({
      url:
        "https://services2.arcgis.com/RPhrOu9XQzI31xTa/arcgis/rest/services/CCHI_Viewsheds_FP/FeatureServer/0",
      outFields: ["*"], 
      renderer: camera,       
      maxScale: 35.505170,  // Starts appearing at zoom level 18
      minScale: 4513.988705,  // Matches hmlayer's maxScale
      visible: true,
      highlightEnabled: false,
      id: "fp"
    });
    

    const hmlayer = new FeatureLayer({
      url:
        "https://services2.arcgis.com/RPhrOu9XQzI31xTa/arcgis/rest/services/CCHI_Viewsheds_FP/FeatureServer/0",
      outFields: ["*"], 
      renderer: hmrenderer,       
      maxScale: 4513.988705,  // Disappears at zoom level 18
      minScale: 591657527.591555,
      visible: true    
    });

    // add all of the layers to the map
    map.addMany([layer, pointlayer, hmlayer]);
    
    // dock popup
    view.popup = {
      dockEnabled: true,
      dockOptions: {
        // Disables the dock button from the popup
        buttonEnabled: false,
        // Ignore the default sizes that trigger responsive docking
        breakpoint: false
      }
    };  

    let homeWidget = new Home({
      view: view
    });

    view.ui.add(homeWidget, "top-left");
    view.ui.move("zoom", "top-left");

    var searchWidget = new Search({
        view: view,
        container: "searchDiv",
        allPlaceholder: "Search photos by keyword",
        includeDefaultSources: false,
        locationEnabled: false,
        sources: []
    });

    let pinGraphic; // To hold the pin graphic

    // Create SVG symbol for the pin
    const svgPin = {
      type: "simple-marker",  // autocasts as new SimpleMarkerSymbol()
      path: "M8 0C3.582 0 0 3.582 0 8c0 5.25 8 12 8 12s8-6.75 8-12c0-4.418-3.582-8-8-8z", // SVG path
      color: "#009af2",
      size: "35px",
      outline: {
        color: [255, 255, 255],
        width: 1
      }
    }; 

    const controlHeatEl = document.getElementById("hmtoggle");

    controlHeatEl.addEventListener("calciteCheckboxChange", async (event) => {
      if ($('#hmtoggle').prop("checked")) {
        hmlayer.visible = true;
        console.log('checked');
      }

      if (!$('#hmtoggle').prop("checked")) {
        hmlayer.visible = false;
        console.log('not checked');
      } 
    }); 

    // Function to query intersecting polygons
    function queryIntersectingPolygons(point) {
      const query = new Query();
      query.geometry = point;  // Use the point as the geometry
      query.spatialRelationship = "intersects";  // Find polygons that intersect with the point
      query.returnGeometry = true;
      query.outFields = ["*"];  // Get all fields

      layer.queryFeatures(query).then(function(results) {
        // Handle the intersecting polygons
        console.log("Intersecting polygons:", results);
        filterItems(point);

      }).catch(function(error) {
        console.error("Error querying polygons: ", error);
      });
    }
    
 // make this layer transparent on click
    const fplayerView = await view.whenLayerView(pointlayer);
    fplayerView.highlightOptions = {
      color: [255, 255, 0, 0],
      haloOpacity: 0.9,
      fillOpacity: 0.2
    };  

  //  const layerView = await view.whenLayerView(layer);*/*/

    function switchMap (year) {      
        // get variable from attributes for the map year string
        const mapstr = "map_" + year;
        console.log(mapstr);
        // Remove the previously active tile layer, if any
        if (activeTileLayer) {
          map.remove(activeTileLayer);
        }
        // Retrieve the tile layer from the tileLayers object
        const tileLayerToAdd = tileLayers[mapstr];
        if (tileLayerToAdd) {
          // Add the retrieved tile layer to the map
          map.add(tileLayerToAdd, 0);
          activeTileLayer = tileLayerToAdd; // Update the active layer
        } else {
          console.log("Tile layer not found for the given map year:", year);
        }
      }

     // custom popup action 
     const addToShoebox = {
        title: "Add to Shoebox",
        id: "shoebox",
        icon: "rectangle-plus"
      }; 

      // get the variation id from CCHI and use it to build the add to shoebox url
      reactiveUtils.on(
        () => view.popup,
        "trigger-action",
        (event) => {
          if (event.action.id === "shoebox") {
            const imgId = view.popup.selectedFeature.attributes.image_no;
            const url = 'https://cchi.mtu.edu/jsonapi/commerce_product/cchi_image_products/?filter[field_image_no]=' + encodeURIComponent(imgId);

            $.ajax({
              url: url,
              async: false, // NOTE: Consider using async/await instead of blocking
              success: function (result) {
                console.log(result);
                if (result.data.length > 0) {
                  const variationId = result.data[0].relationships.variations.data[0].meta.drupal_internal__target_id;
                  console.log(variationId);

                  // Redirect or open the cart link in a new tab
                  const cartUrl = `https://cchi-d11.mtu.edu/cart-links/${variationId}-1`;
                  window.open(cartUrl, '_blank'); // Or use window.location.href = cartUrl to redirect
                } else {
                  console.log("No variation found for this image.");
                }
              },
              error: function (xhr, status, error) {
                console.error("Failed to fetch variationId:", error);
              }
            });
          }
        }
      ) 
          
      // Create a template for the popup
      var template = {
      // autocasts as new PopupTemplate()
      title: "<font color='#009af2'>{title}",  
      actions: [addToShoebox],      
      content: [     
            {
          type: "media",
          mediaInfos: [
            {
              title: "",
              type: "image",
              value: {sourceURL: 'https://cchi-new.mtu.edu/photos/' + '{image_no}.jpg' }
            }
          ]        
            },{
          type: "fields",
          fieldInfos: [
             {
              fieldName: "title",
              label: "Title"
            },
             {
              fieldName: "image_no",
              label: "Image Number"
            },
            {
              fieldName: "date2",
              label: "Date"
            },
            {
              fieldName: "relation",
              label: "Collection"
            },
            {
              fieldName: "desc_",
              label: "Description"
            },
             {
              fieldName: "subject",
              label: "Subject"
            },
           
            {
              fieldName: "notes",
              label: "Notes"
            },
            {
              fieldName: "contributor",
              label: "Contributor"
            },           
            {
              fieldName: "portalUrl",
              label: "PortalUrl"
            },
            {
              fieldName: "resolution",
              label: "Resolution (dpi)"
            },            
          ]
        }, 
      ]
    };

function setFeatureLayerFilter(expression) {
  layer.definitionExpression = expression;  
} 

    // Set the popup template on the layer
    layer.popupTemplate = template;
    pointlayer.popupTemplate = template;     

   // const controlVisitedTypeEl = document.getElementById("control-visited-type-el");
   // const controlThemeEl = document.getElementById("theme");
    const controlGeoEl = document.getElementById("georef");
    const controlMapEl = document.getElementById("selectmap");
    const controlYearEl = document.getElementById("endYear");
   //const controlCountPerStateEl = document.getElementById("control-count-per-state-el");
    const controlResetEl = document.getElementById("control-reset-el");

  //  controlVisitedTypeEl.addEventListener("calciteRadioGroupChange", async (event) => { orderBy = event.target.value, filterItems() });
   // controlThemeEl.addEventListener("calciteSelectChange", async (event) => { theme = event.target.value, filterItems() });
    //controlMapEl.addEventListener("calciteSelectChange", async (event) => { mapyear = event.target.value, filterItems() });
   
    // When the user clicks the search button filter features
    $( ".esri-search__submit-button" ).click(function() {
      filterItems();    
    });

    // When the user clicks the search button filter features
    $( "#searchEtx" ).click(function() {
      $('#instruction').hide();
      // Remove the previous pin if it exists
      if (pinGraphic) {
        view.graphics.remove(pinGraphic);
      }
      const currentExtent = view.extent; 
      filterItems(currentExtent);    
    });

    // When the user clicks the clear button query all features
    $(document).on('click','.esri-search__clear-button', function(){    
      var searchVal = $( "#searchDiv-input" ).val();  
      if (searchVal != '') {
        $( "#searchDiv-input" ).val("");
        console.log(searchVal);
        //filterItems();
      }     
  }); 

  // if users hits enter perform the search   
  $( ".esri-input" ).keyup(function(event) {
      // Number 13 is the "Enter" key on the keyboard
      if (event.keyCode === 13) {
        // Cancel the default action, if needed
        event.preventDefault();
        $('#instruction').hide();
        // Trigger the button element with a click
        $( ".esri-search__submit-button" ).click();
      }        
   });  

  // if the users clicks the search button
  $( ".esri-search__submit-button" ).click(function(event) {
    $('#instruction').hide();
  });  

    const countDefault = 1;
    const orderByDefault = "DESC"
    const yearDefault = "TOTAL"

    let count = countDefault;
    let orderBy = orderByDefault;
    let year = yearDefault;

    async function filterItems(geom) {
      view.popup.close();
      // Create an empty array of search strings
      var searchStrings = [];
      var searchVal = $( "#searchDiv-input" ).val();
      var themeVal = $("#theme").val();
      var mapVal = $("#selectmap").val();
      var startYearVal = $("#startYear").val();
      var endYearVal = $("#endYear").val();
      console.log(searchVal, themeVal);
      let query = layer.createQuery();
      query.returnGeometry = true;

      if (searchVal != '') {
        var searchValString = "(Upper(title) LIKE '%" + searchVal.toUpperCase() + "%' OR Upper(subject) LIKE '%"+ searchVal.toUpperCase() + "%' OR Upper(desc_) LIKE '%" + searchVal + "%' OR Upper(image_no) LIKE '%" + searchVal + "%' OR Upper(date2) LIKE '%" + searchVal + "')"; 
        searchStrings.push(searchValString);
      }
     /* if (searchVal != '') {
        var searchValString = "(Upper(title) LIKE '%" + searchVal.toUpperCase() + "%' OR Upper(subject) LIKE '%"+ searchVal.toUpperCase() + "%' OR Upper(desc_) LIKE '%" + searchVal + "%' OR Upper(image_no) LIKE '%" + searchVal + "%' OR Upper(date2) LIKE '%" + searchVal + "')"; 
        searchStrings.push(searchValString);            
      } *//*else if (searchVal == '') {
        query.where = "1=1";
      } */

     /* if (themeVal != 'none') {
        var themeString = "subject like '%" + themeVal + "%'";
        searchStrings.push(themeString);
      }     
*/
      /*if (mapVal != 'none') {
        var mapString = "mapyear =  '" + mapVal + "'";
        searchStrings.push(mapString);
      }         */

      // Create a query string from the searchStrings array
      var queryString = searchStrings.join(" AND ");
      // Execute the query from the query string
      query.where = queryString;
      query.geometry = geom;
      spatialRelationship = "intersects";
      // Also update the heatmap and point layers
      hmlayer.definitionExpression = queryString;
      pointlayer.definitionExpression = queryString;

     // pointlayer.definitionExpression = query;

      document.getElementById("result-list").innerHTML = "";
      document.getElementById("result-block").open = true;

      const results = await layer.queryFeatures(query);

      graphics = results.features;    

      document.getElementById("result-block").innerHTML = "<h5>Photos in this area (" + graphics.length + ")</h5>"; 

      graphics.forEach((result, index) => {
        const attributes = result.attributes;        
        const item = document.createElement("calcite-list-item");
        const chip = document.createElement("calcite-chip");
        const icon = document.createElement("calcite-icon");
         const thumbnail = document.createElement("img");
        icon.icon = "arrowLeft";
        icon.scale = "s";        
        chip.scale = "s";
        chip.innerText = "";
        chip.icon = "image";
        chip.icon.className = "icon-class";
        thumbnail.slot = "content-start";        
        item.label = attributes.title;
        item.value = index;
        item.description = attributes.date2;
       
  
        // Set the image source to the desired URL
        thumbnail.src = 'https://cchi-new.mtu.edu/photos/' + attributes.image_no + '.jpg';
        
        // Add a class for styling
        thumbnail.className = "thumbnail";
        item.addEventListener("click", () => resultClickHandler(result, index));
        item.appendChild(chip); 
        item.appendChild(thumbnail);       
        document.getElementById("result-list").appendChild(item);
      });

      query.orderByFields = [""];
      const objectIds = await layer.queryObjectIds(query);
      layerView.filter = { objectIds };

     // determineResetActionState();
    }

    function resultClickHandler(result, index) {
      const popup = graphics && graphics[parseInt(index, 10)];
      if (popup) {
        view.popup.open({
          features: [popup],
          location: result.geometry.centroid
        });       
        const extent = result.geometry.extent;
        // when clicking on a record zoom to its extent
        view.goTo({ center: extent.expand(1.5) }, { duration: 400 });

      }
      const imageID = result.attributes.image_no;
      const mapyear = result.attributes.mapyear;
     
      // Change the map
      switchMap(mapyear);

      // Update the image in the Viewer
      updateViewer();
    };  

    function updateViewer() {
      const graphic = view.popup.selectedFeature;
      if (graphic) {
          var thumbUrl = graphic.attributes.image_no;
          var itemTitle = graphic.attributes.title; 
          document.getElementById('image').src = 'https://cchi-new.mtu.edu/photos/' + thumbUrl + '.jpg';
          document.getElementById('image').alt = itemTitle;    
          viewer.update();
      }
    }

    function determineResetActionState() {
      if (searchVal =! '') {
        controlResetEl.removeAttribute("disabled");
        controlResetEl.indicator = true;
      }
      else {
        controlResetEl.disabled = true;
        controlResetEl.removeAttribute("indicator");
      }
    }

    function resetFilters() {
      count = countDefault;
      orderBy = orderByDefault;
      year = yearDefault;

      const activeRadioGroupItem = document.querySelector(`calcite-radio-group-item[value=${orderByDefault}]`)
      activeRadioGroupItem.checked = true;
      controlYearEl.value = yearDefault;
      controlCountPerStateEl.value = countDefault;

      filterItems();
    }

    function createPoint (event) {
     if (highlightSelect) {
      highlightSelect.remove();
      console.log("select");
     }

      $('#instruction').hide();
      // Create a point where the map was clicked
      const point = new Point({
        longitude: event.mapPoint.longitude,
        latitude: event.mapPoint.latitude
      });

      // Remove the previous pin if it exists
      if (pinGraphic) {
        view.graphics.remove(pinGraphic);
      }

      // Create a new graphic for the pin
      pinGraphic = new Graphic({
        geometry: point,
        symbol: svgPin
      });

      // Add the new pin to the view
      view.graphics.add(pinGraphic);

      // Query for intersecting polygons
      queryIntersectingPolygons(point);
    }


     // setup a new viewer to display the map scans
    var viewer = new Viewer(document.getElementById('image'), {
      navbar: false,
      inline: false,
      toolbar: {
        zoomIn: 1,
        zoomOut: 1,
        oneToOne: 1,
        reset: 1,
        prev: 0,
        play: {
          show: 1,
          size: 'large',
        },
        next: 0,
        rotateLeft: 1,
        rotateRight: 1,
        flipHorizontal: 1,
        flipVertical: 1,
      },
      viewed() {
        //viewer.zoomTo(1);
      },
    });  

    
 $(document).ready(function() {
    $(document).on('click', '.esri-features img', function(){ 
        setTimeout(function() {
            updateViewer();
            viewer.show();
        }, 100); // Add a small delay, e.g., 100ms
    });
  });

  const mapPicker = document.getElementById("selectmap");

  mapPicker.addEventListener("calciteSelectChange", async (event) => { 
    console.log(event.target.value);
    switchMap(event.target.value);
  });

  view.on("click", (event) => {
  // only include graphics from the layer in the hitTest
  const opts = {
    include: [layer, pointlayer]
  }
  // check for a click on the index layer
  view.hitTest(event, opts).then((response) => {
    console.log("test: " + response.results);
    // Remove the previous pin if it exists
      if (pinGraphic) {
        view.graphics.remove(pinGraphic);
      }
    // check if a feature is returned from the index layer
    if (response.results.length) {
      const graphic = response.results[0].graphic; 
      console.log(graphic);
      if (graphic.layer.id === "fp") {
        view.whenLayerView(layer).then((layerView) => {
          const id = graphic.attributes.image_no;
          const year = graphic.attributes.mapyear;
          switchMap(year);
          const queryVS = layer.createQuery();
          queryVS.where = "image_no =" + "'" + id + "'";
          layer.queryFeatures(queryVS).then((result) => {
            // if a feature is already highlighted, then remove the highlight
            if (highlightSelect) {
              highlightSelect.remove();
              console.log("select");
            }

            // the feature to be highlighted
            const feature = result.features[0];

            // use the objectID to highlight the feature
            highlightSelect = layerView.highlight(feature.attributes["OBJECTID"]);
          });
        });
        console.log(graphic);
      } else if (graphic.layer.id === "viewsheds") {
          createPoint(event);
      }
    } else if (!response.results.length) {
      createPoint(event);
    }    
  });
});

  // Tour Code

  document.getElementById('start-tour').addEventListener('click', function(e) {
    e.preventDefault(); // Prevent the default link behavior  

    const steps = [
      {
        target: "#viewDiv",
        title: "Find  images by location",
        content: "Click or tap anywhere on the map to see images for that location. Images will show in the sidebar. "
      },
      {
        target: "#searchDiv",
        title: "Search by keyword",
        content: "Use the searchbar to find images by keyword."
      },
      {
      target: "#searchEtx",
        title: "Find images within the maps current extent",
        content: "Click this button to find images within the current viewing area of the map."
      },
      {
      target: "#selectmap",
        title: "Change historical map",
        content: "Use the drop down menu to change the historical Sanborn Fire Insurance Plan overlay map."
      },
      {
      target: "#hmtoggle",
        title: "Heatmap toggle",
        content: "Turn the heat map on and off."
      }
    ];  

    // Create the tour instance
    const tour = new tourguide.TourGuideClient({ steps: steps});  

    // Start the tour
    tour.start();
});
  //  filterItems();
  })());
</script>

</html>
